<!DOCTYPE html>
<html>
<body style="background-color:#1A2735">
<head>
    <h3>Build Version: 20230316-1250</h3>
</head>
<script>

const MASTER_SCHEMA = [];
const RELATIONSHIPS = [];
const GITHUB_ACCOUNT_PREFIX = "https://github.com/cjcaf1995/";

window.onload = function() {
    const GITHUB_ACCOUNT = "cjcaf1995";
    const ENV = "prod";
    const schemaUrl = ENV === "prod" ? "schema.json" : "https://raw.githubusercontent.com/" + GITHUB_ACCOUNT + "/intersection0915/main/schema.json";
    const relationshipUrl = ENV === "prod" ? "relationships.json" : "https://raw.githubusercontent.com/" + GITHUB_ACCOUNT + "/intersection0915/main/relationships.json";
    fetch(schemaUrl)
        .then(response => response.json())
        .then(data => {
            for (var i = 0; i < data.schema.length; i++){
                let currRepositoryEntry = data.schema[i];
                MASTER_SCHEMA.push(currRepositoryEntry);
            }
        });
    fetch(relationshipUrl)
        .then(response => response.json())
        .then(data => {
            for (var i = 0; i < data.all.length; i++){
                let currEntry = data.all[i];
                RELATIONSHIPS.push(currEntry);
            }
            console.log("INITIAL DATA: " + JSON.stringify(RELATIONSHIPS));
        });
}

function shortenUrl(githubUrl) {
    return githubUrl.replaceAll(GITHUB_ACCOUNT_PREFIX, "");
}

openStuff = function () {

    const SAMPLE_ADD_REQUEST = {
        "name": "intersection/issues/7",
        "parent": ["intersection/issues/7-parent"],
        "related": ["intersection/issues/7-related1", "intersection/issues/7-related2"],
        "children": ["intersection/issues/7-child1", "intersection/issues/7-child2"]
    };
    const SAMPLE_ADD_REQUEST_2 = {
        "name": "intersection/issues/8",
        "parent": ["intersection/issues/7"],
        "related": [],
        "children": []
    };
    // Sample Add Relationships
    // finalAddRelationship(ADD_REQUEST);
    // finalAddRelationship(ADD_REQUEST_2);
    // Sample alert(JSON.stringify(RELATIONSHIPS["all"]));

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const originThis = urlParams.get('this');
    const command = urlParams.get('command');
    const commandTokenArr = command.split("_");
    // alert("THIS: " + originThis);
    alert("commandTokenArr: " + commandTokenArr);

    let objCommand = {};
    for (var i = 0; i < commandTokenArr.length; i++){
        let currToken = commandTokenArr[i];
        if (i === 0) {
            objCommand["commandType"] = currToken;    
        } else if (i === 1) {
            objCommand["relationship"] = currToken;
        } else if (i === 2) {
            objCommand["targetIssueIds"] = [];
            let tmpArr = currToken.split("-");
            tmpArr.forEach(function(issueIdLink) {
                objCommand["targetIssueIds"].push(shortenUrl(issueIdLink));
            })
            
        }
    }
    console.log("command object: " + JSON.stringify(objCommand));
    
    let objCommandArr = [objCommand];
    objCommandArr.forEach(function(objCommand){
            let requestObj = {
                "name": originThis,
                "parent": [],
                "related": [],
                "children": []
            };
            if (objCommand["commandType"] === "ADD") {
                if (objCommand["relationship"] === "P") {
                    requestObj["parent"] = objCommand["targetIssueIds"];
                }
                if (objCommand["relationship"] === "R") {
                    requestObj["related"] = objCommand["targetIssueIds"];
                }
                if (objCommand["relationship"] === "C") {
                    requestObj["children"] = objCommand["targetIssueIds"];
                }
                finalAddRelationship(requestObj);
            }
    });
    
    alert("ALL (After Operation): " + JSON.stringify(RELATIONSHIPS));
};

function randomIntFromInterval(min, max) {
    const randomNumber = Math.random();
    return Math.floor(randomNumber * (Number(max) - Number(min) + 1)) + Number(min);
}

function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
}

function mergeArrays(array1, array2) {
    // merge and remove duplicates
    let mergedArray = array1.concat(array2);
    return mergedArray.filter((item, pos) => mergedArray.indexOf(item) === pos); 
}

function queryRecord(name) {
    return RELATIONSHIPS.find(relationship => {
      return relationship.name === name;
    });
}

function hasRecord(name) {
    let objRel = queryRecord(name);
    return objRel !== undefined;
}

function getRecord(name) {
    return queryRecord(name);
}

function addRelationship(requestObj) {
    let alreadyExisting = hasRecord(requestObj["name"]);
    if (alreadyExisting) {
        // SIMPLE ADDITION
        let existingObj = getRecord(requestObj["name"]);
        existingObj["parent"] = mergeArrays(existingObj["parent"], requestObj["parent"]);
        existingObj["related"] = mergeArrays(existingObj["related"], requestObj["related"]);
        existingObj["children"] = mergeArrays(existingObj["children"], requestObj["children"]);   
    } else {
        RELATIONSHIPS.push(requestObj);
    }

}

finalAddRelationship = function(REQUEST_OBJECT) {
    
    addRelationship(REQUEST_OBJECT);
    
    // Identify non-existent relationships (to be added later)
    let arrNewElements = [];
    RELATIONSHIPS.forEach(function(obj){
        let currObjName = obj["name"];
        console.log("MAIN OBJ NAME: " + currObjName);
        let arrParentObj = obj["parent"];
        console.log("PARENT ARRAY: " + JSON.stringify(arrParentObj));
        arrParentObj.forEach(function(parentName){
            console.log("PARENT ELEMENT: " + parentName);
            console.log("PARENT ELEMENT exists: " + hasRecord(parentName));
            if (!hasRecord(parentName)) {
                arrNewElements.push({
                    "name": parentName,
                    "parent": [],
                    "related": [],
                    "children": [currObjName]
                });
            }
        });
    });
    console.log("NEW PARENTS" + JSON.stringify(arrNewElements));
    let arrNewElements2 = [];
    RELATIONSHIPS.forEach(function(obj){
        let currObjName = obj["name"];
        console.log("MAIN OBJ NAME: " + currObjName);
        let arrChildrenObj = obj["children"];
        console.log("CHILDREN ARRAY: " + JSON.stringify(arrChildrenObj));
        arrChildrenObj.forEach(function(childName){
            console.log("CHILD ELEMENT: " + childName);
            console.log("CHILD ELEMENT exists: " + hasRecord(childName));
            if (!hasRecord(childName)) {
                arrNewElements2.push({
                    "name": childName,
                    "parent": [currObjName],
                    "related": [],
                    "children": []
                });
            }
        });
    });
    console.log("NEW CHILDREN" + JSON.stringify(arrNewElements2));
    let arrNewElements3 = [];
    RELATIONSHIPS.forEach(function(obj){
        let currObjName = obj["name"];
        console.log("MAIN OBJ NAME: " + currObjName);
        let arrRelatedObj = obj["related"];
        console.log("SIBLING ARRAY: " + JSON.stringify(arrRelatedObj));
        arrRelatedObj.forEach(function(siblingName){
            console.log("SIBLING ELEMENT: " + siblingName);
            console.log("SIBLING ELEMENT exists: " + hasRecord(siblingName));
            if (!hasRecord(siblingName)) {
                arrNewElements3.push({
                    "name": siblingName,
                    "parent": [],
                    "related": [currObjName],
                    "children": []
                });
            }
        });
    });
    console.log("NEW SIBLINGS" + JSON.stringify(arrNewElements3));
    
    // Add new elements to the RELATIONSHIP object
    arrNewElements.forEach(function(newObj){
        addRelationship(newObj);
    });
    arrNewElements2.forEach(function(newObj){
        addRelationship(newObj);
    });
    arrNewElements3.forEach(function(newObj){
        addRelationship(newObj);
    });
    console.log(JSON.stringify(RELATIONSHIPS));
    RELATIONSHIPS.forEach(function(dbRecord){
        let currObjName = dbRecord["name"];
        // console.log("CURR OBJ: " + currObjName);
        let currSiblingArray = dbRecord["related"];
        // console.log("CURR SIBLINGS: " + JSON.stringify(currSiblingArray));
    });
    
    // Link siblings
    let arrSiblingObjectCollection = [];
    console.log(JSON.stringify(RELATIONSHIPS));
    RELATIONSHIPS.forEach(function(dbRecord){
        let arrSiblingObjects = [];
        let currObjName = dbRecord["name"];
        console.log("CURR OBJ: " + currObjName);
        let currSiblingArray = dbRecord["related"];
        console.log("CURR SIBLINGS: " + JSON.stringify(currSiblingArray));
        arrSiblingObjects = mergeArrays(arrSiblingObjects, currSiblingArray);
        if (arrSiblingObjects.length > 1) {
            arrSiblingObjectCollection.push(arrSiblingObjects);
        }
        console.log(JSON.stringify(arrSiblingObjectCollection));
    });
    arrSiblingObjectCollection.forEach(function(siblingObjArr){
        console.log(JSON.stringify(siblingObjArr));
        siblingObjArr.forEach(function(siblingName){
            let updateRequestPayload = {
                "name": siblingName,
                "parent": [],
                "related": siblingObjArr,
                "children": []
            };
            addRelationship(updateRequestPayload);
        })
    });
    
    // Remove own name from Related Array (Sibling)
    RELATIONSHIPS.forEach(function(dbRecord){
        let arrSiblingObjects = [];
        let currObjName = dbRecord["name"];
        console.log("CURR OBJ: " + currObjName);
        let currSiblingArray = dbRecord["related"];
        let correctSiblingArray = currSiblingArray.filter(e => e !== dbRecord["name"]);
        dbRecord["related"] = correctSiblingArray;
    });
    // alert("PROPER SIBLING LINKAGES: " + JSON.stringify(RELATIONSHIPS["all"]));
}

</script>

<br>
<br>
<br>
<br>
<br>
<div style="text-align:center">
   <button id="randomButton" onclick="openStuff();">実行</button>
   <button><img src="https://c.statcounter.com/12792249/0/85f97432/0/" alt="Web Analytics"  referrerPolicy="no-referrer-when-downgrade"> Visits(20220904)</button>
</div>

</body>
</html>
