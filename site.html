<!DOCTYPE html>
<html>
<body style="background-color:#1A2735">

<script>

window.onload = function() {
    fetch("schema.json")
        .then(response => response.json())
        .then(data => {
            for (var i = 0; i < data.schema.length; i++){
                let currRepository = data.schema[i].full;
                alert(currRepository);
            }
        })
}

function randomIntFromInterval(min, max) {
    const randomNumber = Math.random();
    return Math.floor(randomNumber * (Number(max) - Number(min) + 1)) + Number(min);
}

function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
}

function mergeArrays(array1, array2) {
    // merge and remove duplicates
    let mergedArray = array1.concat(array2);
    return mergedArray.filter((item, pos) => mergedArray.indexOf(item) === pos); 
}

function queryRecord(name) {
    return RELATIONSHIPS["all"].find(relationship => {
      return relationship.name === name;
    });
}

function hasRecord(name) {
    let objRel = queryRecord(name);
    return objRel !== undefined;
}

function getRecord(name) {
    return queryRecord(name);
}

function addRelationship(requestObj) {
    let alreadyExisting = hasRecord(requestObj["name"]);
    if (alreadyExisting) {
        // SIMPLE ADDITION
        let existingObj = getRecord(requestObj["name"]);
        existingObj["parent"] = mergeArrays(existingObj["parent"], requestObj["parent"]);
        existingObj["related"] = mergeArrays(existingObj["related"], requestObj["related"]);
        existingObj["children"] = mergeArrays(existingObj["children"], requestObj["children"]);   
    } else {
        RELATIONSHIPS["all"].push(requestObj);
    }

}

const RELATIONSHIPS_ARCHIVE = {
    "all": [
        // {
            // "name": "intersection/issues/1",
            // "parent": [],
            // "related": [],
            // "children": []
        // },
    ]
};

const RELATIONSHIPS = {
    "all": [
        // {
            // "name": "intersection/issues/1",
            // "parent": [],
            // "related": [],
            // "children": []
        // },
    ]
};

finalAddRelationship = function(REQUEST_OBJECT) {
    
    addRelationship(REQUEST_OBJECT);
    
    // Identify non-existent relationships (to be added later)
    let arrNewElements = [];
    RELATIONSHIPS["all"].forEach(function(obj){
        let currObjName = obj["name"];
        console.log("MAIN OBJ NAME: " + currObjName);
        let arrParentObj = obj["parent"];
        console.log("PARENT ARRAY: " + JSON.stringify(arrParentObj));
        arrParentObj.forEach(function(parentName){
            console.log("PARENT ELEMENT: " + parentName);
            console.log("PARENT ELEMENT exists: " + hasRecord(parentName));
            if (!hasRecord(parentName)) {
                arrNewElements.push({
                    "name": parentName,
                    "parent": [],
                    "related": [],
                    "children": [currObjName]
                });
            }
        });
    });
    console.log("NEW PARENTS" + JSON.stringify(arrNewElements));
    let arrNewElements2 = [];
    RELATIONSHIPS["all"].forEach(function(obj){
        let currObjName = obj["name"];
        console.log("MAIN OBJ NAME: " + currObjName);
        let arrChildrenObj = obj["children"];
        console.log("CHILDREN ARRAY: " + JSON.stringify(arrChildrenObj));
        arrChildrenObj.forEach(function(childName){
            console.log("CHILD ELEMENT: " + childName);
            console.log("CHILD ELEMENT exists: " + hasRecord(childName));
            if (!hasRecord(childName)) {
                arrNewElements2.push({
                    "name": childName,
                    "parent": [currObjName],
                    "related": [],
                    "children": []
                });
            }
        });
    });
    console.log("NEW CHILDREN" + JSON.stringify(arrNewElements2));
    let arrNewElements3 = [];
    RELATIONSHIPS["all"].forEach(function(obj){
        let currObjName = obj["name"];
        console.log("MAIN OBJ NAME: " + currObjName);
        let arrRelatedObj = obj["related"];
        console.log("SIBLING ARRAY: " + JSON.stringify(arrRelatedObj));
        arrRelatedObj.forEach(function(siblingName){
            console.log("SIBLING ELEMENT: " + siblingName);
            console.log("SIBLING ELEMENT exists: " + hasRecord(siblingName));
            if (!hasRecord(siblingName)) {
                arrNewElements3.push({
                    "name": siblingName,
                    "parent": [],
                    "related": [currObjName],
                    "children": []
                });
            }
        });
    });
    console.log("NEW SIBLINGS" + JSON.stringify(arrNewElements3));
    
    // Add new elements to the RELATIONSHIP object
    arrNewElements.forEach(function(newObj){
        addRelationship(newObj);
    });
    arrNewElements2.forEach(function(newObj){
        addRelationship(newObj);
    });
    arrNewElements3.forEach(function(newObj){
        addRelationship(newObj);
    });
    console.log(JSON.stringify(RELATIONSHIPS["all"]));
    RELATIONSHIPS["all"].forEach(function(dbRecord){
        let currObjName = dbRecord["name"];
        // console.log("CURR OBJ: " + currObjName);
        let currSiblingArray = dbRecord["related"];
        // console.log("CURR SIBLINGS: " + JSON.stringify(currSiblingArray));
    });
    
    // Link siblings
    let arrSiblingObjectCollection = [];
    console.log(JSON.stringify(RELATIONSHIPS["all"]));
    RELATIONSHIPS["all"].forEach(function(dbRecord){
        let arrSiblingObjects = [];
        let currObjName = dbRecord["name"];
        console.log("CURR OBJ: " + currObjName);
        let currSiblingArray = dbRecord["related"];
        console.log("CURR SIBLINGS: " + JSON.stringify(currSiblingArray));
        arrSiblingObjects = mergeArrays(arrSiblingObjects, currSiblingArray);
        if (arrSiblingObjects.length > 1) {
            arrSiblingObjectCollection.push(arrSiblingObjects);
        }
        console.log(JSON.stringify(arrSiblingObjectCollection));
    });
    arrSiblingObjectCollection.forEach(function(siblingObjArr){
        console.log(JSON.stringify(siblingObjArr));
        siblingObjArr.forEach(function(siblingName){
            let updateRequestPayload = {
                "name": siblingName,
                "parent": [],
                "related": siblingObjArr,
                "children": []
            };
            addRelationship(updateRequestPayload);
        })
    });
    
    // Remove own name from Related Array (Sibling)
    RELATIONSHIPS["all"].forEach(function(dbRecord){
        let arrSiblingObjects = [];
        let currObjName = dbRecord["name"];
        console.log("CURR OBJ: " + currObjName);
        let currSiblingArray = dbRecord["related"];
        let correctSiblingArray = currSiblingArray.filter(e => e !== dbRecord["name"]);
        dbRecord["related"] = correctSiblingArray;
    });
    // alert("PROPER SIBLING LINKAGES: " + JSON.stringify(RELATIONSHIPS["all"]));
}

openStuff = function () {

    const SAMPLE_ADD_REQUEST = {
        "name": "intersection/issues/7",
        "parent": ["intersection/issues/7-parent"],
        "related": ["intersection/issues/7-related1", "intersection/issues/7-related2"],
        "children": ["intersection/issues/7-child1", "intersection/issues/7-child2"]
    };
    const SAMPLE_ADD_REQUEST_2 = {
        "name": "intersection/issues/8",
        "parent": ["intersection/issues/7"],
        "related": [],
        "children": []
    };
    // Sample Add Relationships
    // finalAddRelationship(ADD_REQUEST);
    // finalAddRelationship(ADD_REQUEST_2);
    // Sample alert(JSON.stringify(RELATIONSHIPS["all"]));

    const SCHEMA = [];
    SCHEMA.push("intersection_a0");
    SCHEMA.push("mrz-angular-js-in-action_a1");
    SCHEMA.push("mrz-spring-boot-in-action_a2");
    SCHEMA.push("mrz-Linux-in-a-Nutshell_a3");
    SCHEMA.push("mrz-linux-commands_a4");
    SCHEMA.push("codebank_a5");
    SCHEMA.push("aws-book-1_a6");
    SCHEMA.push("docker-casual_a7");
    SCHEMA.push("java-casual_a8");

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const repositoryArr = SCHEMA;
    // const repositoryItemsArr = urlParams.get('repositoryItemsArr').split("/"); // a1_1/a1_2/a1_3/a2_1/a2_2
    const commands = "intersection#43_R_intersection#11/intersection#43_C_java-casual#1";
    const commandArr = commands.split("/");
    
    let arrRequests = [];
    commandArr.forEach(function(commandStr){
        let tokenArr = commandStr.split("_");
        let thisName = tokenArr[0];
        let thisRel = tokenArr[1];
        let thisTarget = tokenArr[2];
        let requestObj = {
            "name": thisName,
            "parent": [],
            "related": [],
            "children": []
        };
        if (thisRel === 'P') {
            requestObj["parent"].push(thisTarget);
        } else if (thisRel === 'R') {
            requestObj["related"].push(thisTarget);
        } else if (thisRel === 'C') {
            requestObj["children"].push(thisTarget);
        }
        finalAddRelationship(requestObj);
        alert(JSON.stringify(RELATIONSHIPS["all"]));
    })

};
</script>

<br>
<br>
<br>
<br>
<br>
<div style="text-align:center">
   <button id="randomButton" onclick="openStuff();" >実行</button>
   <button><img src="https://c.statcounter.com/12792249/0/85f97432/0/" alt="Web Analytics"  referrerPolicy="no-referrer-when-downgrade"> Visits(20220904)</button>
</div>

</body>
</html>
